<?xml version='1.0' encoding='UTF-8'?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:p="http://primefaces.org/ui" template="../CSMQ.xhtml">



	<ui:define name="page-content">
	<script>
	function initRelationDND() {
		// define the droppable area on the treetable
		$('.ui-treetable.ui-treetable-currentListsAndSmqs').droppable({
           activeClass: 'ui-state-active',
           hoverClass: 'ui-state-highlight',
           tolerance: 'pointer',
           scope: 'selRelationDnd',
           drop: function(event, ui) {
        	    var dndRow = $(ui.draggable).closest('tr');
        	    
        	    impactSearchToResult([
        	         {name: 'term', value:  $('td:nth-child(2)', dndRow).text()}
        	        ,{name: 'code', value: $('td:nth-child(3)', dndRow).text()}	
        	        ,{name: 'status', value: $('td:nth-child(4)', dndRow).text()}
        	        ,{name: 'state', value: $('td:nth-child(5)', dndRow).text()}
        	        ,{name: 'entityId', value: $('.data-entity-id', dndRow).text()}
        	        ,{name: 'entityType', value: $('.data-entity-type', dndRow).text()}
        	    ]);
        	    
        	    //notifyCreateControllerRelationsModify();
           }
        });

		$('.ui-datatable.ui-datatable-impactedCmqList tr').draggable({
			helper: 'clone',
			scope: 'selRelationDnd',
            zIndex: 10000
		});
		
	}
</script>
<script>initRelationDND()</script>
		<h:form id="impactAssessment">
			<p:growl id="messages" />

			<h:panelGrid columns="1" style="width: 100% !important">
				<p:breadCrumb styleClass="breadcrumb">
					<p:menuitem value="Home" url="/index.xhtml" />
					<p:menuitem value="Impact Assessment" />
				</p:breadCrumb>
			</h:panelGrid>

			<p:wizard flowListener="#{impactSearchController.onIaWizardFlowProcess}">

				<!-- Impact -->
				<p:tab id="impact" title="Impact Assessment">
					<p:toolbar>
						<f:facet name="left">
							<h:outputText value="Impact Assessment"
								style="font-weight: bold;" />
						</f:facet>

						<f:facet name="right">
							<p:commandButton value="Review" id="reviewBtn"
								disabled="#{!impactSearchController.reviewEnabled}"
								action="#{impactSearchController.workflowIAState('review')}" icon="ui-icon-disk"
								process="@this" update="@form">
								<p:confirm header="Confirm Review"
									message="Are you sure you want to confirm this List as reviewed?"
									icon="ui-icon-alert" />
							</p:commandButton>
							<p:spacer width="5" />

							<p:commandButton id="approveBtn" value="Approve" disabled="#{!impactSearchController.approveEnabled}" update="@form"
								 icon="ui-icon-arrowthick-1-n" action="#{impactSearchController.workflowIAState('approve')}" process="@this">
								<p:confirm header="Confirm Approve"
									message="Are you sure you want to approve this List?"
									icon="ui-icon-alert" />
							</p:commandButton>
							<p:spacer width="5" />
							<p:commandButton value="Demote" action="#{impactSearchController.workflowIAState('demote')}" id="demoteBtn" process="@this"
								disabled="#{!impactSearchController.demoteEnabled}" icon="ui-icon-arrowthick-1-s" update="@form">
								<p:confirm header="Confirm Demote"
									message="Are you sure you want to demote this List?"
									icon="ui-icon-alert" />
							</p:commandButton>
							<p:spacer width="5" />
							<p:commandButton value="Delete" actionListener="#" id="deleteBtn"
								onclick="PF('delete').show();" icon="fa fa-trash-o">
								<p:confirm header="Confirm Delete"
									message="Are you sure you want to delete this List?"
									icon="ui-icon-alert" />
							</p:commandButton>
							<p:spacer width="5" />

							<p:commandButton value="Export" actionListener="#"
								icon="fa fa-file-excel-o" update="messages" />
							<p:spacer width="5" />

							<p:commandButton value="Legend" actionListener="#"
								onclick="PF('legend').show()" icon="fa fa-bars"
								update="messages" />
							<p:spacer width="5" />

							<p:submenu label="Options" icon="fa fa-wrench">
								<p:menuButton value="Options">
									<!-- <p:menuitem value="Action 1" actionListener="#" ajax="false"
										icon="ui-icon-close" /> -->
									<p:menuitem>

										<p:selectBooleanCheckbox />
										<p:outputLabel style="margin-left: 5px"
											value="Include LLTs in Export" />
									</p:menuitem>
								</p:menuButton>
							</p:submenu>
						</f:facet>
					</p:toolbar>

					<!-- PANEL -->
					<p:panel>
						<h:panelGrid columns="2" columnClasses="ui-grid-col-6 v-align-top, ui-grid-col-6 v-align-top">
							<p:panel style="width: 100%; padding: 0; overflow: auto !important" id="pan">
								<p:toolbar>
									<f:facet name="left">
										<p:commandButton value="Select Lists/SMQs" actionListener="#" update=""
											icon="fa fa-search" onclick="PF('select_mq').show();" />
									</f:facet>
								</p:toolbar>
								
								<p:remoteCommand name="impactSearchToResult" 
										actionListener="#{impactSearchController.onRelationDrop}" 
										update="@form" 
										oncomplete="initRelationDND()" />
								
								<p:treeTable value="#{impactSearchController.currentTableRootTreeNode}" var="node" widgetVar="currentLists"
									id="currentListsAndSmqs" rows="30" styleClass="ui-treetable-currentListsAndSmqs"
									selectionMode="single" selection="${impactSearchController.currentTableSelection}"
									style=" overflow: auto !important"
									scrollable="true" scrollHeight="200"
									resizableColumns="true" rowStyleClass="#{node.rowStyleClass}">
	
									<f:attribute name="uiEventSourceName" value="current-table" />
									<p:ajax event="expand" listener="#{impactSearchController.onNodeExpandCurrentTable}" update="currentListsAndSmqs" />
									
									<!-- Selection of the list fr workflow states -->
									<p:ajax event="select" listener="#{impactSearchController.onSelectCurrentRowTreeTable}" 
										update="@form:reviewBtn @form:approveBtn @form:demoteBtn @form:deleteBtn @form:futureListsAndSmqs"
										oncomplete="PF('targetLists').unselectAllNodes()" />
										
									<p:ajax event="unselect" listener="#{impactSearchController.onUnselectCurrentRowTreeTable}" 
										update="@form:reviewBtn @form:approveBtn @form:demoteBtn @form:deleteBtn @form:futureListsAndSmqs" />	
																		
									<p:columnGroup type="header">
										<p:row>
											<p:column rowspan="2" headerText="Existing Lists/SMQ" width="50%"/>
											<p:column colspan="3" headerText="Hierarchy Details" />
										</p:row>

										<p:row>
											<p:column headerText="Code" />
											<p:column headerText="Level" />
											<p:column headerText="Scope" />
										</p:row>
									</p:columnGroup>

									<p:column id="c8" width="50%" noWrap="false">
										<h:outputText value="#{node.term}" id="el_c1" />
									</p:column>

									<p:column id="c26" width="25%" >
										<h:outputText value="#{node.code}" id="ot7" />
									</p:column>
									<p:column id="c18" width="15%">
										<h:outputText value="#{node.level}" id="ot14" />
									</p:column>
									<p:column id="c17" width="10%">
										<h:outputText value="#{node.scope}" id="ot13" />
									</p:column>
								</p:treeTable>
							</p:panel>

							<p:panel style="width: 100%; padding: 0">
								<p:toolbar>
									<f:facet name="left">
										<p:commandButton value="Hierarchy Search" actionListener="#"
											icon="fa fa-search" onclick="PF('search').show();" />
										<p:commandButton value="New PTs" actionListener="#"
											onclick="PF('new_pt').show();" icon="fa fa-book" />

										<p:commandButton value="Refresh" actionListener="#"
											icon="fa fa-refresh" onclick="PF('select_mq').show();" />
									</f:facet>
								</p:toolbar>
								
								<p:treeTable value="#{impactSearchController.targetTableRootTreeNode}" var="node" widgetVar="targetLists"
									id="futureListsAndSmqs" rows="30" styleClass="ui-treetable-futureListsAndSmqs"
									selectionMode="single" selection="${impactSearchController.targetTableSelection}"
									style="width: 100%; overflow: auto !important"
									scrollable="true" scrollHeight="200"
									resizableColumns="true" rowStyleClass="#{node.rowStyleClass}" >
								
									<f:attribute name="uiEventSourceName" value="target-table" />
									<p:ajax event="expand" listener="#{impactSearchController.onNodeExpandTargetTable}" update="futureListsAndSmqs" />
									
									<!-- Selection of the list fr workflow states -->
									<p:ajax event="select" listener="#{impactSearchController.onSelectTargetRowTreeTable}" 
										update="@form:messages @form:reviewBtn @form:approveBtn @form:demoteBtn @form:deleteBtn @form:currentListsAndSmqs"
										oncomplete="PF('currentLists').unselectAllNodes()" />
									<p:ajax event="unselect" listener="#{impactSearchController.onUnselectTargetRowTreeTable}" 
										update="@form:messages @form:reviewBtn @form:approveBtn @form:demoteBtn @form:deleteBtn @form:currentListsAndSmqs" />
										
									<p:columnGroup type="header">
										<p:row>
											<p:column rowspan="2" headerText="Future Lists/SMQ"
												width="200" />
											<p:column colspan="5" headerText="Hierarchy Details" />
										</p:row>

										<p:row>
											<p:column headerText="Code" />
											<p:column headerText="Level" />
											<p:column headerText="Scope" />
											<p:column headerText="Category" />
											<p:column headerText="Weight" />
										</p:row>
									</p:columnGroup>

									<p:column>
										<h:outputText value="#{node.term}" id="fl_c1" />
									</p:column>

									<p:column>
										<h:outputText value="#{node.code}" rendered="true" />
									</p:column>
									<p:column headerText="Level" style="width: 50px !important">
										<h:outputText value="#{node.level}" rendered="true" />
									</p:column>

									<p:column>
										<p:selectOneMenu id="soc3" value="#{node.scope}">
											<f:selectItem itemLabel="Broad" itemValue="1" id="si13s" />
											<f:selectItem itemLabel="Narrow" itemValue="2" id="si13d" />
											<f:selectItem itemLabel="Child Narrow" itemValue="3" id="si4" />
										</p:selectOneMenu>
									</p:column>

									<p:column>
										<p:selectOneMenu id="soc2" value="#{node.category}" rendered="true">
											<f:selectItem itemLabel="A" itemValue="A" id="si3" />
											<f:selectItem itemLabel="S" itemValue="S" id="si33" />
											<f:selectItem itemLabel="B" itemValue="B" id="si8" />
											<f:selectItem itemLabel="C" itemValue="C" id="si9" />
											<f:selectItem itemLabel="D" itemValue="D" id="si10" />
											<f:selectItem itemLabel="E" itemValue="E" id="si11" />
											<f:selectItem itemLabel="F" itemValue="F" id="si19" />
											<f:selectItem itemLabel="G" itemValue="G" id="si12" />
											<f:selectItem itemLabel="H" itemValue="H" id="si17" />
											<f:selectItem itemLabel="I" itemValue="I" id="si18" />
										</p:selectOneMenu>
									</p:column>

									<p:column>
										<p:spinner value="#{node.weight}" id="ot6" size="8" />
									</p:column>
								</p:treeTable>
							</p:panel>
						</h:panelGrid>

						<p:commandButton style="margin-top: 10px;" value="Save"
							icon="ui-icon-disk" update="messages" />
					</p:panel>
				</p:tab>

				<!-- Notes -->
				<p:tab id="notes" title="Informative Notes">
					<ui:include src="notes.xhtml"></ui:include>
				</p:tab>

				<!-- Details -->
				<p:tab id="details" title="Details">
					<p:panel header="Details">
						<ui:include src="details.xhtml" />
						<p:commandButton value="Save" icon="ui-icon-disk"
							action="#{impactSearchController.saveDetails}"
							disabled="#{impactSearchController.detailsFormReadonly}" />
					</p:panel>
				</p:tab>
			</p:wizard>

			<p:dialog header="Impact Search" widgetVar="select_mq" onShow="initRelationDND()" width="840px" minWidth="840">
				<ui:include src="../impactCommon/impactSearch.xhtml"></ui:include>

				<p:spacer height="10"></p:spacer>
				<h:panelGrid style="float: right">
					<h:panelGrid columns="2">
						<p:commandButton value="Add selected" onclick="PF('select_mq').hide()"
							update="currentListsAndSmqs futureListsAndSmqs">
							<f:actionListener binding="#{impactSearchController.updateCurrentTable()}"/>
	    					<f:actionListener binding="#{impactSearchController.updateTargetTable()}"/>	
						</p:commandButton>
						<p:commandButton value="Cancel" onclick="PF('select_mq').hide()" />
					</h:panelGrid>
				</h:panelGrid>
				<f:facet name="buttonBar">
					<p:outputLabel value="Last Updated:" id="plam1" />
					<h:outputText value="#{dummyView.value}" id="ot27" />
				</f:facet>
			</p:dialog>

			<p:dialog widgetVar="search" modal="false" header="Hierarchy search" width="740px" minHeight="620">
				<ui:include src="../impactCommon/hierarchySearch.xhtml"></ui:include>

				<p:spacer height="10"></p:spacer>
				<h:panelGrid style="float: right" columns="2">
					<p:commandButton value="Add selected" onclick="PF('search').hide()" update="futureListsAndSmqs"
						action="#{impactSearchController.addSelectedToTargetRelation(impactSearchController.relationSelected)}" />
					<p:commandButton value="Cancel" onclick="PF('search').hide()" immediate="true" />
				</h:panelGrid>
			</p:dialog>

			<p:dialog widgetVar="new_pt" modal="false"
				header="New Preferred Term">
				<h:panelGrid style="width: 500px">
					<h:panelGrid id="pgl1" columns="3">
						<p:outputLabel value="SOC" />
						<p:selectCheckboxMenu id="select"
							value="#{searchController.selectedSOCs}" label="SOC"
							filter="true" filterMatchMode="startsWith" style="width:400px">
							<f:selectItem itemValue="All" itemLabel="All" />
						</p:selectCheckboxMenu>

						<p:commandButton value="Search" id="cb11" partialSubmit="true" />
					</h:panelGrid>
					<p:spacer width="10" height="10" id="s7" />
					<p:dataTable value="#{null}">

						<p:column headerText="Term">
							<h:outputText value="#{dummyView.value}" rendered="true" />
						</p:column>

						<p:column headerText="Level">
							<h:outputText value="#{dummyView.value}" rendered="true" />
						</p:column>
					</p:dataTable>
				</h:panelGrid>

				<p:spacer height="10"></p:spacer>
				<h:panelGrid style="float: right">
					<p:commandButton value="Cancel" onclick="PF('new_pt').hide()" />
				</h:panelGrid>
			</p:dialog>

			<p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
				<p:commandButton value="Yes" type="button"
					styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
				<p:commandButton value="No" type="button"
					styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
			</p:confirmDialog>


			<p:dialog widgetVar="legend" modal="true" id="historyD"
				closable="true" header="Impact Legend">

				<h:panelGrid columns="1">
					<h:panelGrid columns="1">
						<h:panelGrid columns="3">
							<p:graphicImage url="/image/impact/1010.png" />
							<p:spacer width="5" />
							<p:outputLabel value="Impacted"
								style="font-weight: bold; color: blue" />
						</h:panelGrid>
						<h:panelGrid columns="3">
							<p:graphicImage url="/image/impact/1080.png" />
							<p:spacer width="5" />
							<p:outputLabel value="Renamed Terms (Italic= BLACK ball)"
								style="font-weight: bold; color: #000; font-style: italic" />
						</h:panelGrid>
						<h:panelGrid columns="3">
							<p:graphicImage url="/image/impact/1040.png" />
							<p:spacer width="5" height="1" />
							<p:outputLabel value="MedDRA Inserted/Added Term/Relation"
								style="font-weight: bold; color: orange" />
						</h:panelGrid>
						<h:panelGrid columns="3">
							<p:graphicImage url="/image/impact/1070.png" />
							<p:spacer width="5" height="1" />
							<p:outputLabel value="MQM Inserted/Added New PT"
								style="font-weight: bold; color: green" />
						</h:panelGrid>
						<h:panelGrid columns="3">
							<p:graphicImage url="/image/impact/1110.png" />
							<p:spacer width="5" height="1" />
							<p:outputLabel
								value="Other MQM Manual Additions (Bold= WHITE Ball)"
								style="font-weight: bold; color: #000" />
						</h:panelGrid>
						<h:panelGrid columns="3">
							<p:graphicImage url="/image/impact/1020.png" />
							<p:spacer width="5" height="1" />
							<p:outputLabel value="Deleted/Merged/Moved Term/Relation"
								style="font-weight: bold; color: red" />
						</h:panelGrid>
						<h:panelGrid columns="3">
							<p:graphicImage url="/image/impact/1030.png" />
							<p:spacer width="5" height="10" />
							<p:outputLabel value="Non-Current LLT (Future NMQs/SMQs)"
								style="font-weight: bold; color: grey" />
						</h:panelGrid>
						<h:panelGrid columns="3">
							<p:graphicImage url="/image/impact/1050.png" />
							<p:spacer width="5" height="1" />
							<p:outputLabel value="Change in TERMSCP (SMQs)"
								style="font-weight: bold; font-weight: bold; color: pink" />
						</h:panelGrid>
					</h:panelGrid>

					<h:panelGrid style="float: right" columns="1">
						<p:commandButton value="OK" onclick="PF('legend').hide()"
							immediate="true" />
					</h:panelGrid>
				</h:panelGrid>
			</p:dialog>
		</h:form>
		
		<style>
			.ui-chkbox-box {
				display: none !important;
			}
			.green-colored {
				color: #0fe02a;
			}
			
			.green-colored:HOVER {
				color: #0a931a;
			}
		</style>
	</ui:define>
</ui:composition>